<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XSS Detection Performance Metrics</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .nav-buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
        }

        .nav-btn {
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.3s;
        }

        .nav-btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            font-size: 1em;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            margin: 10px 0;
        }

        .stat-card.danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .stat-card.success {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
        }

        .stat-card.warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }

        .section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        .pattern-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .pattern-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #e0e0e0;
        }

        .pattern-item .pattern-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .pattern-item .pattern-count {
            font-size: 1.5em;
            color: #667eea;
            font-weight: bold;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background: #667eea;
            color: white;
            font-weight: bold;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9em;
            font-weight: bold;
        }

        .badge.danger {
            background: #e74c3c;
            color: white;
        }

        .badge.success {
            background: #27ae60;
            color: white;
        }

        .badge.neutral {
            background: #95a5a6;
            color: white;
        }

        .code-snippet {
            font-family: 'Courier New', monospace;
            background: #2c3e50;
            color: #ecf0f1;
            padding: 10px;
            border-radius: 5px;
            font-size: 0.9em;
            word-break: break-all;
            max-width: 400px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>XSS Detection Performance Metrics</h1>
            <p>Comprehensive statistics and analysis of the XSS detection system</p>
        </div>

        <div class="content">
            <div class="nav-buttons">
                <a href="/scanner" class="nav-btn">New Scan</a>
                <a href="/test" class="nav-btn">Test Mode</a>
            </div>

            <!-- Overall Statistics -->
            <div class="section">
                <h2>Overall Statistics</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Total Scans</h3>
                        <div class="stat-value" id="total-scans"><%= statistics.total_scans || 0 %></div>
                    </div>
                    <div class="stat-card danger">
                        <h3>Attacks Detected</h3>
                        <div class="stat-value" id="attacks-detected"><%= statistics.attacks_detected || 0 %></div>
                    </div>
                    <div class="stat-card success">
                        <h3>Clean Inputs</h3>
                        <div class="stat-value" id="clean-inputs"><%= statistics.clean_inputs || 0 %></div>
                    </div>
                    <div class="stat-card warning">
                        <h3>Avg Attack Score</h3>
                        <div class="stat-value" id="avg-score"><%= statistics.avg_attack_score ? statistics.avg_attack_score.toFixed(2) : '0.00' %></div>
                    </div>
                    <div class="stat-card">
                        <h3>Max Attack Score</h3>
                        <div class="stat-value" id="max-score"><%= statistics.max_attack_score || 0 %></div>
                    </div>
                    <div class="stat-card">
                        <h3>Detection Rate</h3>
                        <div class="stat-value" id="detection-rate">
                            <% 
                                const total = statistics.total_scans || 0;
                                const detected = statistics.attacks_detected || 0;
                                const rate = total > 0 ? ((detected / total) * 100).toFixed(1) : '0.0';
                            %>
                            <%= rate + '%' %>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Confusion Matrix -->
            <div class="section">
                <h2>ðŸ§® Confusion Matrix</h2>
                
                <!-- K-Fold Aggregated Confusion Matrix (if available) -->
                <% if (kFoldResults && !kFoldResults.error && kFoldResults.aggregatedConfusionMatrix) { %>
                    <h3 style="margin-bottom: 15px; color: #667eea;">K-Fold Cross-Validation Aggregated Results</h3>
                    <table>
                        <thead>
                            <tr>
                                <th></th>
                                <th>Predicted: Attack</th>
                                <th>Predicted: Clean</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% 
                                const kFoldTotal = kFoldResults.aggregatedConfusionMatrix.true_positives + 
                                                   kFoldResults.aggregatedConfusionMatrix.true_negatives + 
                                                   kFoldResults.aggregatedConfusionMatrix.false_positives + 
                                                   kFoldResults.aggregatedConfusionMatrix.false_negatives;
                                const kFoldTPPercent = kFoldTotal > 0 ? (kFoldResults.aggregatedConfusionMatrix.true_positives / kFoldTotal * 100).toFixed(1) : 0;
                                const kFoldTNPercent = kFoldTotal > 0 ? (kFoldResults.aggregatedConfusionMatrix.true_negatives / kFoldTotal * 100).toFixed(1) : 0;
                                const kFoldFPPercent = kFoldTotal > 0 ? (kFoldResults.aggregatedConfusionMatrix.false_positives / kFoldTotal * 100).toFixed(1) : 0;
                                const kFoldFNPercent = kFoldTotal > 0 ? (kFoldResults.aggregatedConfusionMatrix.false_negatives / kFoldTotal * 100).toFixed(1) : 0;
                            %>
                            <tr>
                                <th>Actual: Attack</th>
                                <td style="background: #d4edda; font-weight: bold;">
                                    <%= kFoldTPPercent + '%' %>
                                </td>
                                <td style="background: #f8d7da; font-weight: bold;">
                                    <%= kFoldFNPercent + '%' %>
                                </td>
                            </tr>
                            <tr>
                                <th>Actual: Clean</th>
                                <td style="background: #f8d7da; font-weight: bold;">
                                    <%= kFoldFPPercent + '%' %>
                                </td>
                                <td style="background: #d4edda; font-weight: bold;">
                                    <%= kFoldTNPercent + '%' %>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <div class="stats-grid" style="margin-top: 20px;">
                        <div class="stat-card success">
                            <h3>Accuracy</h3>
                            <div class="stat-value"><%= (kFoldResults.aggregatedConfusionMatrix.accuracy * 100).toFixed(1) + '%' %></div>
                        </div>
                        <div class="stat-card">
                            <h3>Precision</h3>
                            <div class="stat-value"><%= (kFoldResults.aggregatedConfusionMatrix.precision * 100).toFixed(1) + '%' %></div>
                        </div>
                        <div class="stat-card">
                            <h3>Recall</h3>
                            <div class="stat-value"><%= (kFoldResults.aggregatedConfusionMatrix.recall * 100).toFixed(1) + '%' %></div>
                        </div>
                        <div class="stat-card warning">
                            <h3>F1 Score</h3>
                            <div class="stat-value"><%= (kFoldResults.aggregatedConfusionMatrix.f1_score * 100).toFixed(1) + '%' %></div>
                        </div>
                    </div>
                    
                    <p style="margin-top: 15px; color: #666; font-size: 0.9em;">
                        Aggregated from k-fold cross-validation.
                    </p>
                    
                    <hr style="margin: 30px 0; border: none; border-top: 2px solid #e0e0e0;">
                    <h3 style="margin-bottom: 15px; color: #667eea;">Overall Confusion Matrix (All Labeled Data)</h3>
                <% } %>
                
                <!-- Overall Confusion Matrix -->
                <% if (confusion.total_labeled > 0) { %>
                    <table>
                        <thead>
                            <tr>
                                <th></th>
                                <th>Predicted: Attack</th>
                                <th>Predicted: Clean</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% 
                                const totalLabeled = confusion.true_positives + confusion.true_negatives + 
                                                     confusion.false_positives + confusion.false_negatives;
                                const tpPercent = totalLabeled > 0 ? (confusion.true_positives / totalLabeled * 100).toFixed(1) : 0;
                                const tnPercent = totalLabeled > 0 ? (confusion.true_negatives / totalLabeled * 100).toFixed(1) : 0;
                                const fpPercent = totalLabeled > 0 ? (confusion.false_positives / totalLabeled * 100).toFixed(1) : 0;
                                const fnPercent = totalLabeled > 0 ? (confusion.false_negatives / totalLabeled * 100).toFixed(1) : 0;
                            %>
                            <tr>
                                <th>Actual: Attack</th>
                                <td style="background: #d4edda; font-weight: bold;">
                                    <%= tpPercent + '%' %>
                                </td>
                                <td style="background: #f8d7da; font-weight: bold;">
                                    <%= fnPercent + '%' %>
                                </td>
                            </tr>
                            <tr>
                                <th>Actual: Clean</th>
                                <td style="background: #f8d7da; font-weight: bold;">
                                    <%= fpPercent + '%' %>
                                </td>
                                <td style="background: #d4edda; font-weight: bold;">
                                    <%= tnPercent + '%' %>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <div class="stats-grid" style="margin-top: 20px;">
                        <div class="stat-card success">
                            <h3>Accuracy</h3>
                            <div class="stat-value"><%= (confusion.accuracy * 100).toFixed(1) + '%' %></div>
                        </div>
                        <div class="stat-card">
                            <h3>Precision</h3>
                            <div class="stat-value"><%= (confusion.precision * 100).toFixed(1) + '%' %></div>
                        </div>
                        <div class="stat-card">
                            <h3>Recall</h3>
                            <div class="stat-value"><%= (confusion.recall * 100).toFixed(1) + '%' %></div>
                        </div>
                        <div class="stat-card warning">
                            <h3>F1 Score</h3>
                            <div class="stat-value"><%= (confusion.f1_score * 100).toFixed(1) + '%' %></div>
                        </div>
                    </div>
                    
                    <p style="margin-top: 15px; color: #666; font-size: 0.9em;">
                        Based on labeled samples. Select "Ground Truth" when scanning to improve accuracy metrics.
                    </p>
                <% } else { %>
                    <p style="text-align: center; color: #666; padding: 20px;">
                        No labeled data available yet. Select "Ground Truth" (Malicious/Clean) when scanning inputs to calculate False Positives and False Negatives.
                    </p>
                <% } %>
            </div>

            <!-- K-Fold Cross-Validation -->
            <div class="section">
                <h2>K-Fold Cross-Validation (25% Test Split)</h2>
                <% if (kFoldResults && !kFoldResults.error) { %>
                    <div style="margin-bottom: 20px;">
                        <p style="color: #666; font-size: 0.9em;">Each fold trains on 75% of data and tests on 25%.</p>
                    </div>
                    
                    <!-- Fold Results Table -->
                    <table style="margin-bottom: 20px;">
                        <thead>
                            <tr>
                                <th>Fold</th>
                                <th>Test %</th>
                                <th>Train %</th>
                                <th>TP %</th>
                                <th>TN %</th>
                                <th>FP %</th>
                                <th>FN %</th>
                                <th>Accuracy</th>
                                <th>Precision</th>
                                <th>Recall</th>
                                <th>F1 Score</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% kFoldResults.foldResults.forEach(fold => { 
                                const foldTotal = fold.testSize;
                                const foldCMTotal = fold.true_positives + fold.true_negatives + fold.false_positives + fold.false_negatives;
                                const testPercent = kFoldResults.totalSamples > 0 ? (fold.testSize / kFoldResults.totalSamples * 100).toFixed(1) : 0;
                                const trainPercent = kFoldResults.totalSamples > 0 ? (fold.trainSize / kFoldResults.totalSamples * 100).toFixed(1) : 0;
                                const tpPercent = foldCMTotal > 0 ? (fold.true_positives / foldCMTotal * 100).toFixed(1) : 0;
                                const tnPercent = foldCMTotal > 0 ? (fold.true_negatives / foldCMTotal * 100).toFixed(1) : 0;
                                const fpPercent = foldCMTotal > 0 ? (fold.false_positives / foldCMTotal * 100).toFixed(1) : 0;
                                const fnPercent = foldCMTotal > 0 ? (fold.false_negatives / foldCMTotal * 100).toFixed(1) : 0;
                            %>
                            <tr>
                                <td><strong>Fold <%= fold.fold %></strong></td>
                                <td><%= testPercent %>%</td>
                                <td><%= trainPercent %>%</td>
                                <td><%= tpPercent %>%</td>
                                <td><%= tnPercent %>%</td>
                                <td><%= fpPercent %>%</td>
                                <td><%= fnPercent %>%</td>
                                <td><%= (fold.accuracy * 100).toFixed(1) %>%</td>
                                <td><%= (fold.precision * 100).toFixed(1) %>%</td>
                                <td><%= (fold.recall * 100).toFixed(1) %>%</td>
                                <td><%= (fold.f1_score * 100).toFixed(1) %>%</td>
                            </tr>
                            <% }); %>
                        </tbody>
                    </table>
                    
                    <!-- Average Metrics -->
                    <div class="stats-grid" style="margin-top: 20px;">
                        <div class="stat-card success">
                            <h3>Avg Accuracy</h3>
                            <div class="stat-value"><%= (kFoldResults.averageMetrics.accuracy * 100).toFixed(1) %>%</div>
                            <div style="font-size: 0.8em; margin-top: 5px;">Â±<%= (kFoldResults.standardDeviation.accuracy * 100).toFixed(2) %>%</div>
                        </div>
                        <div class="stat-card">
                            <h3>Avg Precision</h3>
                            <div class="stat-value"><%= (kFoldResults.averageMetrics.precision * 100).toFixed(1) %>%</div>
                            <div style="font-size: 0.8em; margin-top: 5px;">Â±<%= (kFoldResults.standardDeviation.precision * 100).toFixed(2) %>%</div>
                        </div>
                        <div class="stat-card">
                            <h3>Avg Recall</h3>
                            <div class="stat-value"><%= (kFoldResults.averageMetrics.recall * 100).toFixed(1) %>%</div>
                            <div style="font-size: 0.8em; margin-top: 5px;">Â±<%= (kFoldResults.standardDeviation.recall * 100).toFixed(2) %>%</div>
                        </div>
                        <div class="stat-card warning">
                            <h3>Avg F1 Score</h3>
                            <div class="stat-value"><%= (kFoldResults.averageMetrics.f1_score * 100).toFixed(1) %>%</div>
                            <div style="font-size: 0.8em; margin-top: 5px;">Â±<%= (kFoldResults.standardDeviation.f1_score * 100).toFixed(2) %>%</div>
                        </div>
                    </div>
                    
                    <p style="margin-top: 15px; color: #666; font-size: 0.9em;">
                        <strong>Standard Deviation:</strong> Shows the variability of metrics across folds. Lower values indicate more consistent performance.
                    </p>
                <% } else if (kFoldResults && kFoldResults.error) { %>
                    <p style="text-align: center; color: #e74c3c; padding: 20px;">
                        <%= kFoldResults.error %>
                    </p>
                <% } else { %>
                    <p style="text-align: center; color: #666; padding: 20px;">
                        K-fold cross-validation requires labeled data. Please scan inputs with "Ground Truth" labels (Malicious/Clean) to enable cross-validation.
                    </p>
                <% } %>
            </div>

            <!-- Pattern Frequency -->
            <div class="section">
                <h2>Attack Pattern Frequency</h2>
                <div class="pattern-grid" id="pattern-grid">
                    <% 
                        const patternNames = {
                            scriptTag: '<script> Tag',
                            scriptClosing: '</script> Tag',
                            onerror: 'onerror Event',
                            onclick: 'onclick Event',
                            javascript: 'javascript: Protocol',
                            imgTag: '<img> Tag',
                            iframeTag: '<iframe> Tag',
                            eval: 'eval() Function',
                            alert: 'alert() Function'
                        };
                        
                        const patternFreq = patternFrequency || {};
                        const hasPatterns = Object.keys(patternFreq).length > 0;
                        
                        if (hasPatterns) {
                            // Calculate total count for percentage calculation
                            const totalPatternCount = Object.values(patternFreq).reduce((sum, count) => sum + (count || 0), 0);
                            
                            Object.keys(patternNames).forEach(pattern => {
                                const count = patternFreq[pattern] || 0;
                                if (count > 0) {
                                    const percent = totalPatternCount > 0 ? ((count / totalPatternCount) * 100).toFixed(1) : 0;
                    %>
                        <div class="pattern-item">
                            <div class="pattern-name"><%= patternNames[pattern] %></div>
                            <div class="pattern-count"><%= percent %>%</div>
                        </div>
                    <%
                                }
                            });
                        } else {
                    %>
                        <p style="text-align: center; color: #666; padding: 20px;">No attack patterns detected yet. Run some scans to see pattern frequency data.</p>
                    <%
                        }
                    %>
                </div>
            </div>

            <!-- Recent Scans -->
            <div class="section">
                <h2>ðŸ•’ Recent Scans</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Input</th>
                            <th>Status</th>
                            <th>Attack Score</th>
                            <th>Mode</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% if (recentResults && recentResults.length > 0) { %>
                            <% recentResults.forEach(result => { %>
                            <tr>
                                <td><%= new Date(result.timestamp).toLocaleString() %></td>
                                <td>
                                    <div class="code-snippet">
                                        <%= result.raw_input && result.raw_input.length > 50 ? result.raw_input.substring(0, 50) + '...' : (result.raw_input || 'N/A') %>
                                    </div>
                                </td>
                                <td>
                                    <% if (result.is_malicious) { %>
                                        <span class="badge danger">Attack Detected</span>
                                    <% } else { %>
                                        <span class="badge success">No Attack</span>
                                    <% } %>
                                </td>
                                <td><%= result.attack_score || 0 %></td>
                                <td>
                                    <% if (result.mode === 'secure') { %>
                                        <span class="badge success">Secure</span>
                                    <% } else { %>
                                        <span class="badge danger">Vulnerable</span>
                                    <% } %>
                                </td>
                            </tr>
                            <% }); %>
                        <% } else { %>
                            <tr>
                                <td colspan="5" style="text-align: center; padding: 20px; color: #666;">
                                    No scan results yet. Run some scans to see recent activity.
                                </td>
                            </tr>
                        <% } %>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</body>
</html>

